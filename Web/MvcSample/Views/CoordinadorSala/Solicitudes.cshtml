@using System
@using System.Collections.Generic
@using Microsoft.AspNetCore.Mvc.Rendering
@model IList<Services.Models.ModelosSolicitud.ModeloSolicitud>
@{
    var estadoActual = ViewBag.Estado as string ?? "Pendiente";
    var usuarios = ViewBag.Usuarios as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
    var equipos = ViewBag.Computadores as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
    var estadosSelect = ViewBag.EstadosSelect as IEnumerable<SelectListItem> ?? Array.Empty<SelectListItem>();
    var salas = ViewBag.SalasDic as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
}

<div class="equipos-table-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Solicitudes de préstamo</h2>
            <p>Gestiona las solicitudes enviadas por los usuarios</p>
        </div>
        <a class="btn-agregar-equipo" asp-action="Principal" asp-controller="CoordinadorSala">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
    </div>

    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label text-muted">Estado</label>
            @Html.DropDownList("estado", estadosSelect, htmlAttributes: new { @class = "form-select", onchange = "this.form.submit()" })
        </div>
    </form>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <table class="table equipos-table">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Equipo</th>
                <th>Sala</th>
                <th>Tipo</th>
                <th>Desde</th>
                <th>Hasta</th>
                <th>Estado</th>
                <th>Descripción</th>
                <th class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model == null || Model.Count == 0)
            {
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">No hay solicitudes en este estado</td>
                </tr>
            }
            else
            {
                foreach (var solicitud in Model)
                {
                    <tr>
                        <td>@(usuarios.TryGetValue(solicitud.UsuarioId, out var nombreUsuario) ? nombreUsuario : solicitud.UsuarioId.ToString())</td>
                        <td>@(equipos.TryGetValue(solicitud.ComputadorId, out var nombreEquipo) ? nombreEquipo : solicitud.ComputadorId.ToString())</td>
                        <td>@(solicitud.SalaId.HasValue && salas.TryGetValue(solicitud.SalaId.Value, out var salaNombre) ? salaNombre : "-")</td>
                        <td>@solicitud.Tipo</td>
                        <td>@solicitud.FechaInicio.ToString("g")</td>
                        <td>@solicitud.FechaFin.ToString("g")</td>
                        <td>
                            @{
                                var estado = solicitud.Estado ?? "Pendiente";
                                var clase = estado switch
                                {
                                    "Pendiente" => "tag tag-mantenimiento",
                                    "Aceptado" => "tag tag-disponible",
                                    "Denegado" => "tag tag-bloqueado",
                                    _ => "tag tag-mantenimiento"
                                };
                            }
                            <span class="@clase">@estado</span>
                        </td>
                        <td>@(string.IsNullOrWhiteSpace(solicitud.Descripcion) ? "-" : solicitud.Descripcion)</td>
                        <td class="text-end">
                            @if (estadoActual.Equals("Pendiente", StringComparison.OrdinalIgnoreCase))
                            {
                                <form asp-action="AceptarSolicitud" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@solicitud.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-check2 me-1"></i>Aceptar
                                    </button>
                                </form>
                                <form asp-action="DenegarSolicitud" method="post" class="d-inline ms-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@solicitud.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-x-lg me-1"></i>Denegar
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted">Sin acciones</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

